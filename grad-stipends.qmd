---
title: "Graduate Stipend Study: Fall 2018-2023"
author: "The Ad Hoc Committee (Graduate Council)"
format: 
  html:
    theme: simplex
    fontsize: 11pt

filters: 
  - lightbox
  - nutshell
lightbox: auto

editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE,
  fig.retina = 3, fig.align = 'center', out.width = '100%', 
  fig.width = 8, fig.height = 8
  )

library(tidyverse)

```

# Data Cleaning

Let us start by reading in the csv file.


```{r}

readr::read_csv(
  "oudata/Stipend Analysis FY18-FY23.csv"
  ) %>%
  janitor::clean_names() -> stipends_1823

```

We have a total of `r nrow(stipends_1823)` rows of data. How many of these are unique?  

```{r}

stipends_1823 %>%
  group_by(
    appointment_year, pid, account
    ) %>%
  mutate(
    nrows = n()
    ) -> stipends_1823

```

```{r}

stipends_1823 %>%
  ungroup() %>%
  count(nrows)

```

### Three Rows of data? 

```{r}

stipends_1823 %>%
  filter(nrows == 3) %>%
  select(1, 4, 7, 10, 11) %>%
  arrange(pid, appointment_year, fall_offer_amount) %>%
  DT::datatable(options = list(pageLength = 12), rownames = FALSE) %>% 
  DT::formatStyle(columns = c(1:5), fontSize = '85%')

```

### Two Rows of data 

```{r}

stipends_1823 %>%
  filter(nrows == 2) %>%
  select(1, 4, 7, 10, 11) %>%
  arrange(pid, appointment_year, fall_offer_amount) %>%
  DT::datatable(options = list(pageLength = 12), rownames = FALSE) %>% 
  DT::formatStyle(columns = c(1:5), fontSize = '85%')

```

> So the question is: How do we reliably aggregate to the appointment year and calculate `total offer amount` and `total work hours`? 


The answer turns out to be that this is an OBI issue with a workaround:

1. Create the total amount per term by adding up the amounts if the amounts differ per row 
2. Create the total amount per term by taking the amount as is if the amount does not differ per row
3. For work hours, drop all 0 hours and add up the rest for a maximum of 20. Reset anything that exceeds 20 to 20. 
4. Make sure the dollars and the hours are aggregated separately. 


## Adding total hours per Fall term per PID

```{r}

stipends_1823 %>%
  select(
    appointment_year, pid, work_hours, stipend_type
    ) %>%
  filter(
    !is.na(work_hours)
    ) -> dfa1

dfa1 %>%
  group_by(appointment_year, pid) %>%
  summarize(
    total_fall_hours = sum(work_hours, na.rm = TRUE)
    ) %>%
  mutate(
    total_fall_hours = ifelse(total_fall_hours > 20, 20, total_fall_hours)
    ) -> dfa3

```

## Adding total amount per Fall term per PID

```{r}

stipends_1823 %>%
  select(
    appointment_year, pid, fall_offer_amount
    ) -> dfb1

dfb1 %>%
  filter(
    !is.na(fall_offer_amount)
    ) %>%
  group_by(
    appointment_year, pid, fall_offer_amount
    ) %>%
  distinct(., .keep_all = TRUE) %>%
  group_by(
    appointment_year, pid
    ) %>%
  summarize(
    total_fall_amounts = sum(fall_offer_amount, na.rm = TRUE)
    ) -> dfb2

```

## Merging hours and amounts

```{r}

dfb2 %>%
  full_join(
    dfa3,
    by = c("appointment_year", "pid")
    ) -> dfab

dfab %>%
  ungroup() %>%
  filter(
    total_fall_amounts > 0 & total_fall_hours > 0
    ) -> mydf

```

## Merging hours and amounts back 

```{r}

stipends_1823 %>%
  select(
    appointment_year, pid, school_name,
    program_code, program_name
    ) %>%
  distinct(
    .,
    .keep_all = TRUE
    ) -> for_merge

mydf %>%
  left_join(
    for_merge,
    by = c("appointment_year", "pid")
    ) -> stipends_df

```







```{r, eval=FALSE}

readr::read_csv(
  "oudata/Stipend Analysis FY18-FY23.csv"
  ) %>%
  janitor::clean_names() %>%
  mutate(
    hashid = openssl::md5(pid)
  ) -> stipends

stipends %>%
  select(pid, hashid) -> hash_crosswalk

hash_crosswalk %>%
  write_csv(
    .,
    file = "oudata/hash_crosswalk.csv"
    )

stipends %>%
  relocate(hashid) %>%
  select(- pid) -> stipends

```

## CPI Adjustment

```{r, eval=FALSE}

readxl::read_excel(
  "SeriesReport-20221208145833_79ca87.xlsx",
  skip = 11
  ) -> cpi_allu

readxl::read_excel(
  "SeriesReport-20221208151855_7c44f7.xlsx",
  skip = 11
  ) -> cpi_midwest_b

cpi_midwest_b %>%
  select(Year, Sep) %>%
  mutate(
    appointment_year = Year + 1
    ) %>%
  filter(
    appointment_year >= 2018
    ) -> cpi_midwest_sub

cpi_midwest_sub %>%
  mutate(
    base = 148.023,
    index = case_when(
      Year == 2017 ~ 100,
      Year > 2017 ~ (Sep / base) * 100
      )
    ) -> cpi_midwest_sub

```

```{r, eval=FALSE}

load("oudata/stipends.RData")

stipends %>%
  left_join(
    cpi_midwest_sub,
    by = "appointment_year"
    ) -> stipends

stipends %>%
  mutate(
    real_fall_offer_amount = (100 / index) * fall_offer_amount
  ) -> stipends

stipends %>%
  group_by(
    hashid, appointment_year, program_name
    ) %>%
  mutate(
    total_fall_offer_amount = sum(
      fall_offer_amount,
      na.rm = TRUE
      ),
    real_total_fall_offer_amount = sum(
      real_fall_offer_amount,
      na.rm = TRUE
      )
    ) -> stipends

save(stipends, file = "oudata/stipends.RData")

```


```{r}

load("~/Downloads/grad_stipends/oudata/stipends.RData")

stipends %>%
  mutate(
    school_name = ifelse(
      school_name == "GVS Leadership & Pub Affairs", 
      "GVS Leadership & Pub Service", 
      school_name
      )
    ) -> stipends

```

# Some Context for this Report
The Ad-hoc Graduate Stipend Review committee was asked to both look at OHIO's stipends over the years, and to the extent possible, compare OHIO's stipends to those of peer institutions. OHIO Fall 2021 data were provided by the Graduate College for 2022, along with data used in the 2021-2022 Graduate Assistant Stipend Survey report authored by Institutional research and Analytics at Oklahoma State University. 

In this initial report we focus only on OHIO's data. In particular, we start with a unit-level database that includes one row per stipend source per student in the Fall semester of 2017 through 2022. If a student was funded from multiple sources, then each source shows up as row in the database. Consequently, to create a student-level database with one row of data per student we aggregated up from the raw data such that we calculated total hours for which a stipend was offered in the Fall semester, as well as the total dollar amount of the offered stipend. To adjust for inflation we utilized the September value of the Consumer Price Index (CPI) for the Midwest, and rendered all annual amounts in terms of the purchasing power of a 2018 dollar.  

# Exploratory Analysis
We started by asking a series of simple questions: How many unique students received a stipend by year? How do these stipends break down by stipend type (GA, TA, RA, GRS)? What does this portrait look like at the school, at the department-within-school level?  

```{r}

stipends %>%
  group_by(hashid, appointment_year) %>% 
  mutate(
    total_work_hours = sum(work_hours, na.rm = TRUE)
    ) -> stipends

stipends %>%
  select(
    hashid, appointment_year, stipend_type, school_name,
    program_name, real_total_fall_offer_amount, total_work_hours
    ) %>%
  distinct() -> stipends_nodups

```

```{r}

stipends_nodups %>%
  group_by(appointment_year) %>%
  count() -> tab01

stipends_nodups %>%
  group_by(
    appointment_year, stipend_type
    ) %>%
  count() %>%
  group_by(appointment_year) %>%
  mutate(
    total = sum(n)
    ) %>%
  group_by(
    appointment_year, total
    ) %>%
  pivot_wider(
    names_from = stipend_type,
    values_from = n
    ) -> tab02

stipends_nodups %>%
  group_by(
    appointment_year, stipend_type, school_name
    ) %>%
  count() %>%
  group_by(appointment_year, school_name) %>%
  mutate(
    school_total = sum(n)
    ) %>%
  group_by(
    appointment_year, school_total, school_name
    ) %>%
  pivot_wider(
    names_from = stipend_type,
    values_from = n
    ) -> tab03

stipends_nodups %>%
  group_by(
    appointment_year, stipend_type, school_name, program_name
    ) %>%
  count() %>%
  group_by(appointment_year, school_name) %>%
  mutate(
    school_total = sum(n)
    ) %>%
  group_by(appointment_year, school_name, program_name) %>%
  mutate(
    program_total = sum(n)
    ) %>%
  group_by(
    appointment_year, school_total, school_name, program_name, program_total
    ) %>%
  pivot_wider(
    names_from = stipend_type,
    values_from = n
    ) -> tab04

```

```{r}

tab01 %>%
  knitr::kable(
    booktabs = TRUE,
    col.names = c("Apointment Year (Fall)", "Number of Stipends"),
    caption = "Total Number of Students with a Stipend per Appointment Year") %>%
  kableExtra::kable_styling(
    full_width = FALSE, bootstrap_options = c("striped", "hover")
    ) 

```

```{r}

tab02 %>%
  knitr::kable(
    booktabs = TRUE,
    col.name = c("Appointment Year (Fall)", "Total No. of Stipends", "GA", "GRS", "RA", "RD", "TA"),
    caption = "Total Number of Students with a Stipend per Appointment Year, by Stipend Type") %>%
  kableExtra::kable_styling(
    full_width = FALSE, bootstrap_options = c("striped", "hover")
    )

```

```{r}

tab03 %>%
  arrange(school_name, appointment_year) %>%
  DT::datatable(caption = "Total Stipnds by Type, Appointment Year, and College")

```

```{r, eval=FALSE}

tab03 %>%
  group_by(appointment_year, school_name, school_total) %>%
  pivot_longer(
    names_to = "stype",
    values_to = "number",
    cols = 4:8
  ) %>% 
  filter(!is.na(school_name)) %>%
  ggplot() +
  geom_bar(
    aes(
      x = forcats::fct_reorder(school_name, -school_total),
      y = number,
      group = stype,
      fill = stype
      ),
    stat = "identity"
    ) +
  facet_wrap(~ appointment_year) +
  coord_flip() +
  labs(
    x = "",
    y = "Number of Stipends",
    fill = ""
    ) +
  themeani::theme_ani_poppins() +
  theme(legend.position = "bottom")

```

> How has the number of stipends changed over time? 

```{r}

library(highcharter)

tab03 %>%
  group_by(appointment_year, school_name, school_total) %>%
  pivot_longer(
    names_to = "stype",
    values_to = "number",
    cols = 4:8
  ) %>% 
  filter(!is.na(school_name)) %>%
  hchart(
    ., 
    "line", 
    hcaes(
      x = appointment_year, 
      y = school_total, 
      group = school_name
      )
    ) %>%
  hc_xAxis(title = list(text = "Appointment Year")) %>%
  hc_yAxis(title = list(text = "Number of Stipends"))

```

> What about school-level trends? 

```{r}

tab03 %>%
  select(1:3) %>%
  group_by(school_name) %>%
  filter(!is.na(school_name)) %>%
  pivot_wider(
    names_from = appointment_year,
    values_from = school_total
  ) %>%
  arrange(school_name) %>%
  rename(
    "School" = school_name
  ) %>%
  knitr::kable(booktabs = TRUE) %>%
  kableExtra::kable_styling(
    full_width = FALSE, bootstrap_options = c("striped", "hover")
    ) %>%
  kableExtra::row_spec(., c(2, 6, 7), bold = TRUE, color = "green") %>%
  kableExtra::row_spec(., c(3, 4, 5, 9), bold = TRUE, color = "red")

```

> How do programs trend over time? 

```{r, eval = FALSE}

tab04 %>%
  dplyr::group_by(program_name, appointment_year) %>%
  dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
  dplyr::filter(n > 1L) 

```



```{r}

tab04 %>%
  ungroup() %>%
  select(1:3, 5) %>%
  group_by(school_name, program_name) %>%
  filter(!is.na(program_name)) %>%
  pivot_wider(
    names_from = appointment_year,
    values_from = program_total
  ) -> tab04b 

```

```{r}

tab04b %>%
  arrange(school_name, program_name) %>%
  DT::datatable()

```

# The Hours

What do stipends look like in terms of the typical number of hours offered, and the range of hours? Well, we start this exploration by looking at the entire distribution of hours for OHIO as a whole, by appointment year.

```{r}

stipends_nodups %>%
  group_by(appointment_year) %>%
  count(total_work_hours)

```



What were the minimum, maximum, mean, and median number of hours stipends were written for by year?

```{r}

stipends_nodups %>%
  group_by(appointment_year) %>%
  summarize(
    Min.Nominal = min(total_work_hours, na.rm = TRUE),
    Mean.Nominal = mean(total_work_hours, na.rm = TRUE),
    Median.Nominal = median(total_work_hours, na.rm = TRUE),
    Max.Nominal = max(total_work_hours, na.rm = TRUE)
    ) -> tab05

```


How does this break down by GA, TA, RA, GRS? 


How do the preceding 4. and 5. break down by Department?  


What do minimum, maximum, mean, and median stipends look like by year? Both nominal and real?


What does the breakdown look like by GA, TA, RA, GRS?


What about breaking the preceding down by Department?


How have the mean and median stipends changed over time? By GA, TA, RA, GRS? What if we break this down by Department?  




